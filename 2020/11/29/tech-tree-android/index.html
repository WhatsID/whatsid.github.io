<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="ä¸ªäººæŠ€èƒ½æ ‘-Android">
<meta property="og:url" content="http://whatsid.me/2020/11/29/tech-tree-android/index.html">
<meta property="og:site_name" content="Now Or Never">
<meta property="og:description" content="åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-11-29T03:14:18.000Z">
<meta property="article:modified_time" content="2021-01-30T09:59:14.203Z">
<meta property="article:author" content="WhatsID">
<meta name="twitter:card" content="summary">






  <link rel="canonical" href="http://whatsid.me/2020/11/29/tech-tree-android/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ä¸ªäººæŠ€èƒ½æ ‘-Android | Now Or Never</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

<meta name="generator" content="Hexo 6.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Now Or Never</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />é¦–é¡µ</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />å½’æ¡£</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://whatsid.me/2020/11/29/tech-tree-android/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="WhatsID">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Now Or Never">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ä¸ªäººæŠ€èƒ½æ ‘-Android
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-11-29 11:14:18" itemprop="dateCreated datePublished" datetime="2020-11-29T11:14:18+08:00">2020-11-29</time>
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹ã€‚</p>
<span id="more"></span>

<h2 id="ä¸€ã€Android"><a href="#ä¸€ã€Android" class="headerlink" title="ä¸€ã€Android"></a>ä¸€ã€Android</h2><h3 id="Activityå¯åŠ¨æµç¨‹-API-28"><a href="#Activityå¯åŠ¨æµç¨‹-API-28" class="headerlink" title="Activityå¯åŠ¨æµç¨‹ (API 28)"></a>Activityå¯åŠ¨æµç¨‹ (API 28)</h3><p><strong>Step1. ä»ç‚¹å‡»åº”ç”¨å›¾æ ‡åˆ°AMSçš„è°ƒç”¨</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1. Launcherè°ƒç”¨startActivity </span><br><span class="line">2. Activity#startActivity </span><br><span class="line">3. Activity#startActivityForResult </span><br><span class="line">4. Instrumentation#execStartActivity,å†…éƒ¨é€šè¿‡AIDLè°ƒç”¨AMS#startActivity,ä¼ å…¥IApplicationThreadçš„å¥æŸ„,æœ¬åœ°å®ç°ä¸ºActivityThreadçš„å†…éƒ¨ç±»ApplicationThread</span><br><span class="line">5. AMS#startActivityAsUser</span><br><span class="line">6. ActivityStarter#execute</span><br><span class="line">7. ActivityStarter#startActivityMayWait,å†…éƒ¨è°ƒç”¨åˆ°startActivityUnchecked</span><br><span class="line">8. ActivityStackSupervisor#resumeFocusedStackTopActivityLocked</span><br><span class="line">9. ActivityStack#resumeTopActivityUncheckedLocked,å†…éƒ¨è°ƒç”¨åˆ°resumeTopActivityInnerLocked</span><br><span class="line">10. ActivityStackSupervisor#startSpecificActivityLocked </span><br></pre></td></tr></table></figure>

<p><strong>Step2. AMSè°ƒç”¨Zygoteåˆ›å»ºappè¿›ç¨‹</strong><br>åœ¨ActivitySupervisor#startSpecificActivityLockedæ–¹æ³•ä¸­ï¼Œä¼šåˆ¤æ–­appè¿›ç¨‹æ˜¯å¦å·²ç»è¢«åˆ›å»ºï¼Œrå¦‚æœå·²ç»åˆ›å»ºï¼Œåˆ™ç›´æ¥ä»Step5å¼€å§‹ç»§ç»­ã€‚åˆ™å¦‚æœè¿˜æ²¡æœ‰è¢«åˆ›å»ºï¼Œåˆ™å¼€å§‹è¿›è¡Œappè¿›ç¨‹åˆå§‹åŒ–å·¥ä½œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">void startSpecificActivityLocked(ActivityRecord r, boolean andResume, boolean checkConfig) &#123;</span><br><span class="line">    // Is this activity&#x27;s application already running?</span><br><span class="line">    ProcessRecord app = mService.getProcessRecordLocked(r.processName,</span><br><span class="line">                r.info.applicationInfo.uid, true);</span><br><span class="line"></span><br><span class="line">    getLaunchTimeTracker().setLaunchTime(r);</span><br><span class="line">    // appè¿›è¡Œæ˜¯å¦è¢«åˆ›å»º</span><br><span class="line">    if (app != null &amp;&amp; app.thread != null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == 0</span><br><span class="line">                    || !&quot;android&quot;.equals(r.info.packageName)) &#123;</span><br><span class="line">                app.addPackage(r.info.packageName, r.info.applicationInfo.longVersionCode,</span><br><span class="line">                        mService.mProcessStats);</span><br><span class="line">            &#125;</span><br><span class="line">            	// å·²ç»åˆ›å»ºï¼Œè¿›å…¥activityå¯åŠ¨æµç¨‹</span><br><span class="line">            realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class="line">            return;</span><br><span class="line">        &#125; catch (RemoteException e) &#123;</span><br><span class="line">            Slog.w(TAG, &quot;Exception when starting activity &quot;</span><br><span class="line">                    + r.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // æ²¡æœ‰åˆ›å»ºï¼Œå¼€å§‹åˆ›å»ºappè¿›ç¨‹</span><br><span class="line">    mService.startProcessLocked(r.processName, r.info.applicationInfo, true, 0,&quot;activity&quot;, 		r.intent.getComponent(), false, false, true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºappè¿›ç¨‹çš„æ–¹æ³•è°ƒç”¨æµç¨‹ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. ActivitySupervisor#startProcessLocked</span><br><span class="line">2. AMS#startProcessLocked,è¿™é‡ŒæŒ‡å®šäº†entryPoint=android.app.ActivityThread,ç„¶åå†…éƒ¨è°ƒç”¨è‡³startProcess</span><br><span class="line">3. Process#start </span><br><span class="line">4. ZygoteProcess#start</span><br><span class="line">5. ZygoteProcess#startViaZygote</span><br><span class="line">6. ZygoteProcess#openZygoteSocketIfNeeded, æ‰“å¼€æœ¬åœ°Socketï¼ŒAMSä½œä¸ºClient</span><br><span class="line">7. ZygoteProcess#zygoteSendArgsAndGetResult,é€šè¿‡Socketå‘Zygoteè¿›ç¨‹å‘é€ä¸€ä¸ªå‚æ•°åˆ—è¡¨,ç„¶åå°±è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°è¿œç¨‹SocketæœåŠ¡ç«¯è¿”å›æ–°åˆ›å»ºçš„è¿›ç¨‹pidã€‚</span><br></pre></td></tr></table></figure>

<p><strong>Step3. Zygoteå¤„ç†Socketè¯·æ±‚ï¼Œåˆ›å»ºå­è¿›ç¨‹å¹¶åå°„è°ƒç”¨ActivityThreadçš„mainå‡½æ•°</strong><br>åœ¨Androidç³»ç»Ÿå¯åŠ¨è¿›è¡Œåˆå§‹åŒ–æ—¶ï¼Œé¦–å…ˆä¼šåˆå§‹åŒ–Zygoteè¿›ç¨‹çš„ç›¸å…³å†…å®¹ã€‚åœ¨ZygoteInitçš„mainå‡½æ•°ä¸­,ä¼šåˆå§‹åŒ–ZygoteServer,å¹¶è°ƒç”¨ZygoteServer#runSelectLoopæ¥æ­»å¾ªç¯ç›‘å¬Socketçš„Clientï¼ˆAMSï¼‰å‘æ¥çš„æ¶ˆæ¯ã€‚æ–¹æ³•è°ƒç”¨æµç¨‹ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. ZygoteServer#runSelectLoop</span><br><span class="line">2. ZygoteConnection#processOneCommand()</span><br><span class="line">3. Zygote.forkAndSpecialize()</span><br><span class="line">4. Zygote#nativeForkAndSpecialize</span><br></pre></td></tr></table></figure>

<p>processOneCommandæ–¹æ³•ä»£ç å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Runnable processOneCommand(ZygoteServer zygoteServer) &#123;</span><br><span class="line">	...çœç•¥éƒ¨åˆ†ä»£ç </span><br><span class="line">	</span><br><span class="line">	//forkè¿›ç¨‹</span><br><span class="line">	pid = Zygote.forkAndSpecialize(...);</span><br><span class="line">   try &#123;</span><br><span class="line">        if (pid == 0) &#123;</span><br><span class="line">            // in child,å­è¿›ç¨‹æ‰§è¡Œ</span><br><span class="line">            zygoteServer.setForkChild();</span><br><span class="line"></span><br><span class="line">            zygoteServer.closeServerSocket();</span><br><span class="line">            IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">            serverPipeFd = null;</span><br><span class="line"></span><br><span class="line">		    //è¿›å…¥å­è¿›ç¨‹æµç¨‹,parsedArgs.startClasså°±æ˜¯ActivityThreadç±»ï¼Œæ˜¯å‰é¢AMSé€šè¿‡Socketå‘é€è¿‡æ¥çš„</span><br><span class="line">            return handleChildProc(parsedArgs, descriptors, childPipeFd,</span><br><span class="line">                        parsedArgs.startChildZygote);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // çˆ¶è¿›ç¨‹æ‰§è¡Œ</span><br><span class="line">            IoUtils.closeQuietly(childPipeFd);</span><br><span class="line">            childPipeFd = null;</span><br><span class="line">            handleParentProc(pid, descriptors, serverPipeFd);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        IoUtils.closeQuietly(childPipeFd);</span><br><span class="line">        IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€æ‰§è¡Œå­è¿›ç¨‹ï¼Œè¿™é‡Œå³appè¿›ç¨‹æµç¨‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. ZygoteConnection#handleChildProc</span><br><span class="line">2. ZygoteInit#zygoteInit</span><br><span class="line">3. RuntimeInit#commonInit()ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­è®¾ç½®äº†çº¿ç¨‹çš„DefaultUncaughtExceptionHandler</span><br><span class="line">4. RuntimeInit#applicationInit </span><br><span class="line">5. RuntimeInit#findStaticMain</span><br><span class="line">6. RuntimeInit#MethodAndArgsCaller,åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å°†ActivityThreadçš„mainæ–¹æ³•åŒ…è£…ä¸ºRunnableå¹¶å‘ä¸Šè¿”å›,Runnableæ¥æ”¶è€…ä¸ºZygoteInitçš„mainæ–¹æ³•,æ¥æ”¶åˆ°Runnableçš„è¿”å›ä¹‹åå°±ç›´æ¥è°ƒç”¨äº†runnable.run()ï¼Œæ­¤æ—¶ä¾¿è°ƒç”¨äº†ActivityThreadçš„mianæ–¹æ³•</span><br></pre></td></tr></table></figure>

<p><strong>Step4. ActivityThreadçš„mainæ–¹æ³•</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. ActivityThreadçš„mianæ–¹æ³•ä¸­ï¼Œå¯åŠ¨äº†ä¸»çº¿ç¨‹looperï¼Œå¹¶åˆ›å»ºäº†ActivityThreadå®ä¾‹ï¼Œç„¶åè°ƒç”¨ActivityThread#attach</span><br><span class="line">2. AIDLè°ƒç”¨AMS#attachApplication</span><br><span class="line">3. AMS#attachApplicationLocked</span><br><span class="line">4. AIDLè°ƒç”¨ApplicationThread#bindApplication,åŒæ—¶AMS#attachApplicationLockedæ–¹æ³•è¿˜ä¼šè°ƒç”¨ActivityStackSupervisor#attachApplicationLocked,è¿™ä¸ªåœ¨Step5ä¸­è¿›è¡Œåˆ†æ</span><br><span class="line">5. ApplicationThreadçš„bindApplicationä¸­é€šè¿‡H.sendMessage(H.BIND_APPLICATION,data)</span><br><span class="line">6. ActivityThread#handleBindApplication,è¯¥æ–¹æ³•ä¸­å®Œæˆäº†Instrumentationå®ä¾‹çš„åˆ›å»ºã€Applicationå®ä¾‹çš„åˆ›å»ºå¹¶è°ƒç”¨åˆ°äº†Application.onCreate,è‡³æ­¤appè¿›ç¨‹å¯åŠ¨ï¼Œå¹¶å®Œæˆäº†Applicationç±»çš„åˆ›å»ºå’Œå¯åŠ¨</span><br></pre></td></tr></table></figure>

<p><strong>Step5. Activityçš„å¯åŠ¨</strong><br>åœ¨Step4çš„ç¬¬å››æ­¥ä¸­,AMS#attachApplicationLockedæ–¹æ³•é¦–å…ˆä¼šé€šè¿‡AIDLè°ƒç”¨ApplicationThread#bindApplicationï¼Œç„¶åè°ƒç”¨äº†ActivityStackSupervisor#attachApplicationLockedã€‚å‰è€…ä¼šå®ŒæˆApplicationçš„åˆ›å»ºå’Œå¯åŠ¨ï¼Œç”±äºAIDLæ–¹æ³•ä¼šé˜»å¡è°ƒç”¨æ–¹çš„ç»§ç»­æ‰§è¡Œï¼Œåœ¨Applicationå®Œæˆåˆ›å»ºå’Œå¯åŠ¨åï¼ŒAMSä¼šç»§ç»­æ‰§è¡Œåˆ°ActivityStackSupervisor#attachApplicationLocked,è¯¥æ–¹æ³•å†…éƒ¨ä¼šå°è¯•ä»ActivityListç¼“å­˜ä¸­å¯»æ‰¾appè¿›ç¨‹æ˜¯å¦æœ‰å¾…å¯åŠ¨çš„activity(è¿™é‡Œæ˜¯æœ‰ç¼“å­˜çš„activityçš„ï¼Œåœ¨Step1çš„ç¬¬10æ­¥ä¸­ï¼Œåœ¨å¯åŠ¨activityä¹‹å‰ä¼šå…ˆåˆ¤æ–­appè¿›è¡Œæœ‰æ²¡æœ‰å¯åŠ¨ï¼Œæ²¡æœ‰çš„è¯å…ˆå¯åŠ¨appè¿›ç¨‹ï¼Œå¾…å¯åŠ¨çš„activityå·²ç»è¢«ç¼“å­˜èµ·æ¥äº†)ã€‚å¦‚æœæœ‰çš„è¯ä¼šè°ƒç”¨realStartActivityLockedï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">final boolean realStartActivityLocked(...) throws RemoteException &#123;</span><br><span class="line">	...çœç•¥ä»£ç ...</span><br><span class="line">	final ClientTransaction clientTransaction = ClientTransaction.obtain(app.thread, r.appToken);</span><br><span class="line">	// æ³¨é‡Š1ï¼šæ·»åŠ LaunchActivityItem</span><br><span class="line">	clientTransaction.addCallback(LaunchActivityItem.obtain(new Intent(r.intent),</span><br><span class="line">                        System.identityHashCode(r), r.info,</span><br><span class="line"></span><br><span class="line">	final ActivityLifecycleItem lifecycleItem;</span><br><span class="line">	if (andResume) &#123;</span><br><span class="line">		// æ³¨é‡Š2ï¼šæ·»åŠ ResumeActivityItem</span><br><span class="line">            lifecycleItem = ResumeActivityItem.obtain(mService.isNextTransitionForward());</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            lifecycleItem = PauseActivityItem.obtain();</span><br><span class="line">        &#125;</span><br><span class="line">        clientTransaction.setLifecycleStateRequest(lifecycleItem);</span><br><span class="line"></span><br><span class="line">        // æ‰§è¡Œtransaction</span><br><span class="line">        mService.getLifecycleManager().scheduleTransaction(clientTransaction); </span><br><span class="line">        ...çœç•¥ä»£ç ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æ³¨é‡Š1å’Œæ³¨é‡Š2å¤„ï¼Œå‘ClientTransactionä¸­æ·»åŠ äº†LaunchActivityItemå’ŒResumeActivityItemï¼Œè®°ä½è¿™ä¸¤ä¸ªitemï¼Œåé¢ä¼šæœ‰ç”¨ã€‚ç„¶åæ‰§è¡Œäº†mService.getLifecycleManager().scheduleTransaction(clientTransaction);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClientLifecycleManager#scheduleTransactionæ–¹æ³•ï¼š</span><br><span class="line">void scheduleTransaction(ClientTransaction transaction) throws RemoteException &#123;</span><br><span class="line">	final IApplicationThread client = transaction.getClient();</span><br><span class="line">      transaction.schedule();</span><br><span class="line">      if (!(client instanceof Binder)) &#123;</span><br><span class="line">            transaction.recycle();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">ClientTransaction#getClientå’Œschedule()æ–¹æ³•ï¼š</span><br><span class="line">private IApplicationThread mClient;</span><br><span class="line">public IApplicationThread getClient() &#123;</span><br><span class="line">    return mClient;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">public void schedule() throws RemoteException &#123;</span><br><span class="line">    mClient.scheduleTransaction(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mClientå°±æ˜¯åœ¨å®¢æˆ·ç«¯çš„å®ç°æ˜¯ApplicationThreadï¼Œæ‰€ä»¥æœ€ç»ˆæ‰§è¡Œåˆ°äº†ApplicationThread#scheduleTransactionæ–¹æ³•:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. ApplicationThread#scheduleTransaction</span><br><span class="line">2. ActivityThread#scheduleTransaction</span><br><span class="line">3. TrasactionExecutor#execute</span><br></pre></td></tr></table></figure>
<p>TrasactionExecutor#executeæ–¹æ³•å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public void execute(ClientTransaction transaction) &#123;</span><br><span class="line">    final IBinder token = transaction.getActivityToken();</span><br><span class="line">    log(&quot;Start resolving transaction for client: &quot; + mTransactionHandler + &quot;, token: &quot; + token);</span><br><span class="line"></span><br><span class="line">    executeCallbacks(transaction);</span><br><span class="line"></span><br><span class="line">    executeLifecycleState(transaction);</span><br><span class="line">    mPendingActions.clear();</span><br><span class="line">    log(&quot;End resolving transaction&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void executeCallbacks(ClientTransaction transaction) &#123;</span><br><span class="line">    final List&lt;ClientTransactionItem&gt; callbacks = transaction.getCallbacks();</span><br><span class="line">    if (callbacks == null) &#123;</span><br><span class="line">        // No callbacks to execute, return early.</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    ...çœç•¥ä»£ç ...</span><br><span class="line">    final int size = callbacks.size();</span><br><span class="line">    for (int i = 0; i &lt; size; ++i) &#123;</span><br><span class="line">        final ClientTransactionItem item = callbacks.get(i);</span><br><span class="line">        ...çœç•¥ä»£ç ...</span><br><span class="line">        item.execute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">        item.postExecute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">        ...çœç•¥ä»£ç ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">private void executeLifecycleState(ClientTransaction transaction) &#123;</span><br><span class="line">    final ActivityLifecycleItem lifecycleItem = transaction.getLifecycleStateRequest();</span><br><span class="line">    if (lifecycleItem == null) &#123;</span><br><span class="line">         return;</span><br><span class="line">    &#125;</span><br><span class="line">    ...çœç•¥ä»£ç ...</span><br><span class="line">    lifecycleItem.execute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">    lifecycleItem.postExecute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶å®å°±æ˜¯é¡ºåºæ‰§è¡Œäº†LaunchActivityItemå’ŒResumeActivityItemï¼ˆè¿˜è®°å¾—è¿™ä¸¤ä¸ªitemå—ï¼‰çš„executeæ–¹æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void execute(...) &#123;</span><br><span class="line">    ...çœç•¥ä»£ç ...</span><br><span class="line">    client.handleLaunchActivity(r, pendingActions, null /* customIntent */);</span><br><span class="line">    ...çœç•¥ä»£ç ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void execute(...) &#123;</span><br><span class="line">    ...çœç•¥ä»£ç ...</span><br><span class="line">    client.handleResumeActivity(token, true /* finalStateRequest */, mIsForward,</span><br><span class="line">            &quot;RESUME_ACTIVITY&quot;);</span><br><span class="line">    ...çœç•¥ä»£ç ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>handleLaunchActivityå’ŒhandleResumeActivityä¸­å®Œæˆäº†Activityçš„åˆ›å»ºå’Œå±•ç¤ºï¼Œå…·ä½“çš„ä»£ç ç»†èŠ‚å°±ä¸è´´äº†ã€‚åˆ°è¿™é‡Œæ•´ä¸ªappå°±å¯åŠ¨èµ·æ¥äº†ã€‚</p>
<h3 id="Viewç»˜åˆ¶æµç¨‹-API-28"><a href="#Viewç»˜åˆ¶æµç¨‹-API-28" class="headerlink" title="Viewç»˜åˆ¶æµç¨‹ (API 28)"></a>Viewç»˜åˆ¶æµç¨‹ (API 28)</h3><p>åœ¨ä¸Šé¢Activityçš„å¯åŠ¨æµç¨‹ä¸­ï¼Œæœ€åä¼šè°ƒç”¨handleResumeActivityï¼Œç»˜åˆ¶æµç¨‹å°±ä»è¿™é‡Œå¼€å§‹åˆ†æã€‚</p>
<p>handleResumeActivityæ–¹æ³•ä¸­ä¼šè°ƒç”¨performResultActivity,è¯¥æ–¹æ³•ä¸­ä¼šè°ƒç”¨Activity#performResume,ä»è€Œå®Œæˆå¯¹onStartå’ŒonResumeæ–¹æ³•çš„å›è°ƒã€‚</p>
<p>å†å›åˆ°handleResumeActivityæ–¹æ³•ä¸­ï¼Œè¯¥æ–¹æ³•ä¸­æœ‰ä¸€æ®µå…³é”®ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">if (r.window == null &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">	// r.windowçš„å®ç°ç±»ä¸ºPhoneWindowï¼ŒPhoneWindowçš„åˆ›å»ºæ˜¯åœ¨activity#attachæ–¹æ³•ä¸­ï¼Œattachæ–¹æ³•æ˜¯ActivityThread#performLaunchActivityæ–¹æ³•è°ƒç”¨çš„</span><br><span class="line">	r.window = r.activity.getWindow();</span><br><span class="line">	// PhoneWindow#getDecorViewä¸­å¦‚æœdecorä¸ºç©ºï¼Œä¼šæ‰§è¡ŒinstallDecoræ¥å®ŒæˆDecorViewçš„åˆ›å»ºï¼ŒåŒæ—¶å°†DecorViewå’ŒPhoneWindowå…³è”èµ·æ¥</span><br><span class="line">	View decor = r.window.getDecorView();</span><br><span class="line">	// è¿™é‡Œå°†decorè®¾ç½®ä¸ºä¸å¯è§ï¼Œæš‚æ—¶è¿˜æ²¡æ‰¾åˆ°åœ¨å“ªé‡Œè®¾ç½®ä¸ºå¯è§</span><br><span class="line">	decor.setVisibility(View.INVISIBLE);</span><br><span class="line">	// wmå®ç°ç±»ä¸ºWindowManagerImpl</span><br><span class="line">	ViewManager wm = a.getWindowManager();</span><br><span class="line">	WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">	a.mDecor = decor;</span><br><span class="line">	...çœç•¥ä»£ç ...</span><br><span class="line">	if (a.mVisibleFromClient) &#123;</span><br><span class="line">		if (!a.mWindowAdded) &#123;</span><br><span class="line">			a.mWindowAdded = true;</span><br><span class="line">			// é‡ç‚¹æ–¹æ³•</span><br><span class="line">			wm.addView(decor, l);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			...çœç•¥ä»£ç ...</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WindowManagerImplæ˜¯å…¸å‹çš„æ¡¥æ¥æ¨¡å¼å®ç°ï¼Œå†…éƒ¨å°†æ‰€æœ‰æ–¹æ³•éƒ½å§”æ‰˜ç»™äº†WindowManagerGlobalæ¥å®ç°ï¼Œæ‰€ä»¥ç›´æ¥çœ‹WindowManagerGlobal#addView:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public void addView(View view, ViewGroup.LayoutParams params,</span><br><span class="line">        Display display, Window parentWindow) &#123;</span><br><span class="line">    ...çœç•¥ä»£ç ...</span><br><span class="line"></span><br><span class="line">    ViewRootImpl root;</span><br><span class="line">    View panelParentView = null;</span><br><span class="line"></span><br><span class="line">    synchronized (mLock) &#123;</span><br><span class="line">        ...çœç•¥ä»£ç ...</span><br><span class="line"></span><br><span class="line">        root = new ViewRootImpl(view.getContext(), display);</span><br><span class="line"></span><br><span class="line">        view.setLayoutParams(wparams);</span><br><span class="line"></span><br><span class="line">        mViews.add(view);</span><br><span class="line">        mRoots.add(root);</span><br><span class="line">        mParams.add(wparams);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // è°ƒç”¨äº†ViewRootImpl#setView</span><br><span class="line">            root.setView(view, wparams, panelParentView);</span><br><span class="line">        &#125; catch (RuntimeException e) &#123;</span><br><span class="line">            // BadTokenException or InvalidDisplayException, clean up.</span><br><span class="line">            if (index &gt;= 0) &#123;</span><br><span class="line">                removeViewLocked(index, true);</span><br><span class="line">            &#125;</span><br><span class="line">            throw e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ViewRootImpl#setViewä¸­è°ƒç”¨äº†requestLayout:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void requestLayout() &#123;</span><br><span class="line">    if (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">        checkThread();</span><br><span class="line">        mLayoutRequested = true;</span><br><span class="line">        scheduleTraversals();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void scheduleTraversals() &#123;</span><br><span class="line">    if (!mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = true;</span><br><span class="line">        // è¿™é‡Œé€šè¿‡handlerå‘é€äº†ä¸€ä¸ªåŒæ­¥å±éšœï¼Œåœ¨åé¢ä»‹ç»æ¶ˆæ¯æœºåˆ¶çš„æ—¶å€™å†è§£é‡ŠåŒæ­¥å±éšœ</span><br><span class="line">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class="line">        // Choreographerå°±å…ˆä¸ä»‹ç»äº†ï¼Œå’Œå±å¹•åˆ·æ–°æœºåˆ¶æœ‰å…³ï¼Œé‡ç‚¹å…³æ³¨mTraversalRunnable</span><br><span class="line">        mChoreographer.postCallback(</span><br><span class="line">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null);</span><br><span class="line">        if (!mUnbufferedInputDispatch) &#123;</span><br><span class="line">            scheduleConsumeBatchedInput();</span><br><span class="line">        &#125;</span><br><span class="line">        notifyRendererOfFramePending();</span><br><span class="line">        pokeDrawLockIfNeeded();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">final class TraversalRunnable implements Runnable &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        doTraversal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void doTraversal() &#123;</span><br><span class="line">    if (mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = false;</span><br><span class="line">        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</span><br><span class="line"></span><br><span class="line">        if (mProfile) &#123;</span><br><span class="line">            Debug.startMethodTracing(&quot;ViewAncestor&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">	  // è¿™é‡Œå°±æ˜¯ç»˜åˆ¶æµç¨‹çš„èµ·æºå•¦</span><br><span class="line">        performTraversals();</span><br><span class="line"></span><br><span class="line">        if (mProfile) &#123;</span><br><span class="line">            Debug.stopMethodTracing();</span><br><span class="line">            mProfile = false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨performTraversalsæ–¹æ³•ä¸­ä¾æ¬¡è°ƒç”¨äº†performMeasureã€performLayoutã€performDrawæ–¹æ³•æ¥å®ŒæˆViewç»˜åˆ¶çš„ä¸‰å¤§æµç¨‹ï¼šæµ‹é‡ã€å¸ƒå±€å’Œç»˜åˆ¶ã€‚å¦å¤–ViewRootImplä¸­è¿˜æ¶‰åŠåˆ°äº†Choreographerå±å¹•åˆ·æ–°æœºåˆ¶ã€invalidateå’ŒrequestLayoutçš„åŒºåˆ«ç­‰å†…å®¹ï¼Œè¿™é‡Œå°±ä¸å†å¤šä»‹ç»äº†ï¼Œæˆ‘ä¹Ÿæ‡’å¾—å†™äº†å¼å¼å¼ğŸ˜</p>
<h3 id="Androidæ¶ˆæ¯æœºåˆ¶"><a href="#Androidæ¶ˆæ¯æœºåˆ¶" class="headerlink" title="Androidæ¶ˆæ¯æœºåˆ¶"></a>Androidæ¶ˆæ¯æœºåˆ¶</h3><p>Androidæ¶ˆæ¯æœºåˆ¶ä¸­ä¸»è¦æœ‰Handlerã€Looperã€MessageQueueã€ThreadLocalã€ThreadLocalMapç­‰å‡ ä¸ªé‡ç‚¹ç±»ã€‚ä½†æ˜¯å®åœ¨ä¸çŸ¥é“è¯¥å†™ç‚¹å•¥ï¼Œæ„Ÿè§‰æ²¡ä»€ä¹ˆéš¾ç‚¹ï¼ˆèœé¸¡çš„è¿·ä¹‹è‡ªä¿¡ï¼‰ã€‚éšä¾¿å†™ç‚¹ä¸ªäººç†è§£å§ã€‚(å¯èƒ½æœ‰è¯¯</p>
<ol>
<li>Androidæ˜¯ä»¥æ¶ˆæ¯æœºåˆ¶ä¸ºé©±åŠ¨çš„ç³»ç»Ÿï¼Œäº‹ä»¶åœ¨åº•å±‚äº§ç”Ÿï¼Œä¼ åˆ°ç³»ç»Ÿå±‚ï¼Œå†ç”±ç³»ç»Ÿå±‚ç”¨AIDLçš„æ–¹å¼åˆ†å‘ç»™å„åº”ç”¨è¿›ç¨‹ï¼Œåº”ç”¨å—åˆ°äº‹ä»¶åè¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚å¦‚æœæ²¡æœ‰äº‹ä»¶äº§ç”Ÿï¼Œåº”ç”¨è¿›ç¨‹éœ€è¦ç­‰å¾…æ¶ˆæ¯çš„äº§ç”Ÿå†åšç›¸åº”çš„å¤„ç†ã€‚æ‰€ä»¥å¿…ç„¶æœ‰æŸç§ç­‰å¾…æ¶ˆæ¯æ—¶çš„é˜»å¡æœºåˆ¶ã€‚</li>
<li>ApplicationThreadä½œä¸ºBinderæœºåˆ¶åœ¨clientä¸­çš„å®ç°ç±»ï¼Œåœ¨æ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åä½¿ç”¨mHå°†æ¶ˆæ¯ç›´æ¥ä¼ é€’ç»™ActivityThreadï¼Œå…·ä½“çš„è¡Œä¸ºéƒ½æ˜¯åœ¨ActivityThreadä¸­è¿›è¡Œçš„ã€‚mHæ˜¯ActivityThreadä¸­çš„Handlerç±»å‹çš„æˆå‘˜å˜é‡ï¼Œåœ¨ActivityThread#mainä¸­ä¼šåˆå§‹åŒ–Looperï¼ŒLooperçš„åˆå§‹åŒ–çº¿ç¨‹ä¸ºä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥æ¶ˆæ¯éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­å¤„ç†çš„ã€‚</li>
<li>åœ¨ActivityThread#mainä¸­ï¼Œæœ€åä¸¤è¡Œä»£ç ï¼š</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Looper.loop();</span><br><span class="line"></span><br><span class="line">throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯å¦‚æœæ‰§è¡Œåˆ°äº†Looper.loop()çš„ä¸‹ä¸€è¡Œï¼Œç¨‹åºå°±ä¼šæŠ›å‡ºå¼‚å¸¸ç„¶åé€€å‡ºï¼Œæ‰€ä»¥Looper.loop()å¿…ç„¶éœ€è¦æ˜¯æ­»å¾ªç¯ã€‚</p>
<ol start="4">
<li>Looper#loopä¸ºæ­»å¾ªç¯ï¼Œå…¶å®å¹¶ä¸æ˜¯å› ä¸ºloopä¸­çš„æ­»å¾ªç¯é˜»å¡äº†ï¼Œè€Œæ˜¯å› ä¸ºæ–¹æ³•ä¸­çš„queue.next()é˜»å¡äº†ï¼Œä¸€æ—¦queue.next()è¿”å›ç©ºçš„msgï¼Œæ–¹æ³•å°±ä¼šreturnä»è€Œé€€å‡ºï¼Œæ‰€ä»¥æ­£å¸¸æƒ…å†µä¸‹queue.next()è¦ä¹ˆè¿”å›æ­£å¸¸çš„msgï¼Œè¦ä¹ˆé˜»å¡ã€‚å¦‚æœè¿”å›äº†ç©ºmsgï¼Œåˆ™ä»£è¡¨ç¨‹åºè¦é€€å‡ºäº†(é’ˆå¯¹main looperè€Œè¨€)ã€‚</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public static void loop() &#123;</span><br><span class="line">    ...çœç•¥ä»£ç ...</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        Message msg = queue.next(); // might block</span><br><span class="line">        if (msg == null) &#123;</span><br><span class="line">            // No message indicates that the message queue is quitting.</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        ...çœç•¥ä»£ç ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>MessageQueue#nextæ–¹æ³•ä¸­æœ‰å¯¹åŒæ­¥å±éšœè¿›è¡Œå¤„ç†çš„ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºå•çº¯è®¾ç½®msg.setAsynchronous(true)å¹¶ä¸èƒ½ç”ŸæˆåŒæ­¥å±éšœï¼Œç”ŸæˆåŒæ­¥å±éšœéœ€è¦msg.target &#x3D;&#x3D; null</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Message prevMsg = null;</span><br><span class="line">Message msg = mMessages;</span><br><span class="line">if (msg != null &amp;&amp; msg.target == null) &#123;</span><br><span class="line">    // Stalled by a barrier.  Find the next asynchronous message in the queue.</span><br><span class="line">    do &#123;</span><br><span class="line">        prevMsg = msg;</span><br><span class="line">        msg = msg.next;</span><br><span class="line">    &#125; while (msg != null &amp;&amp; !msg.isAsynchronous());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>MessageQueueä¸­æœ‰postSyncBarrieræ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯å”¯ä¸€å¯ä»¥äº§ç”Ÿmsg.target &#x3D;&#x3D; nullçš„æ–¹æ³•ï¼Œåœ¨Handlerä¸­æ‰€æœ‰sendMessageã€postDelayç­‰æ–¹æ³•æœ€ç»ˆéƒ½ä¼šèµ°åˆ°enqueueMessageæ–¹æ³•ä¸­ï¼Œè¯¥æ–¹æ³•ä¼šç»™message.targetèµ‹å€¼:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) &#123;</span><br><span class="line">    msg.target = this;</span><br><span class="line">    if (mAsynchronous) &#123;</span><br><span class="line">        msg.setAsynchronous(true);</span><br><span class="line">    &#125;</span><br><span class="line">    return queue.enqueueMessage(msg, uptimeMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>MessageQueue#nextæ–¹æ³•ä¸­çš„nextPollTimeoutMilliså˜é‡ï¼Œ-1ä»£è¡¨ä¸€ç›´é˜»å¡ï¼Œç›´åˆ°è°ƒç”¨nativeWakeæ¥å”¤é†’ï¼›0ä»£è¡¨ä¸ä¼šé˜»å¡ï¼Œç«‹å³è¿”å›ï¼›&gt;0ä»£è¡¨æœ€é•¿é˜»å¡nextPollTimeoutMillisæ¯«ç§’ï¼ŒæœŸé—´å¦‚æœè°ƒç”¨nativeWakeåˆ™ç«‹å³è¿”å›ã€‚</p>
</li>
<li><p>IdleHandleråªä¼šåœ¨MessageQueue#nextç¬¬ä¸€æ¬¡å¾ªç¯æ—¶è¢«è°ƒç”¨ã€‚ï¼ˆï¼Ÿ</p>
</li>
<li><p>ThreadLocalå¹¶ä¸æ˜¯çº¿ç¨‹æœ¬åœ°å˜é‡ï¼ŒThreadLocalMapæ‰æ˜¯ï¼Œåªä¸è¿‡é€šè¿‡ThreadLocalå¯ä»¥å–å‡ºThreadä¸­çš„ThreadLocalMapã€‚ThreadLocalMapæ˜¯ThreadLocalä¸­çš„é™æ€å†…éƒ¨ç±»ã€‚</p>
</li>
<li><p>ThreadLocalMapä¸­çš„æ•°æ®ç»“æ„æ˜¯æ•°ç»„+Mapã€‚Mapçš„keyä¸ºè½¯å¼•ç”¨ï¼Œæ„å‘³ç€å¦‚æœkeyçš„å®ä¾‹æ²¡æœ‰å¼ºå¼•ç”¨å­˜åœ¨æ—¶ï¼Œä¸ä¼šå› ä¸ºThreadLocalMapä¸­çš„å¼•ç”¨å¯¼è‡´å†…å­˜æ³„æ¼ã€‚åŒæ—¶åœ¨ThreadLocalMapçš„set&#x2F;get&#x2F;removeç­‰æ–¹æ³•ä¸­ï¼Œä¼šæ£€æŸ¥keyä¸ºç©ºçš„å†…å®¹ï¼Œå°†valueä¹Ÿç½®ä¸ºç©ºï¼Œé˜²æ­¢valueçš„å†…å­˜æ³„æ¼ã€‚</p>
</li>
</ol>
<h3 id="Binderæœºåˆ¶ï¼ˆå®³æ²¡å†™"><a href="#Binderæœºåˆ¶ï¼ˆå®³æ²¡å†™" class="headerlink" title="Binderæœºåˆ¶ï¼ˆå®³æ²¡å†™"></a>Binderæœºåˆ¶ï¼ˆå®³æ²¡å†™</h3><h3 id="Androidç¼–è¯‘æµç¨‹"><a href="#Androidç¼–è¯‘æµç¨‹" class="headerlink" title="Androidç¼–è¯‘æµç¨‹"></a>Androidç¼–è¯‘æµç¨‹</h3><h2 id="äºŒã€JavaåŸºç¡€çŸ¥è¯†"><a href="#äºŒã€JavaåŸºç¡€çŸ¥è¯†" class="headerlink" title="äºŒã€JavaåŸºç¡€çŸ¥è¯†"></a>äºŒã€JavaåŸºç¡€çŸ¥è¯†</h2><h2 id="ä¸‰ã€Kotlin"><a href="#ä¸‰ã€Kotlin" class="headerlink" title="ä¸‰ã€Kotlin"></a>ä¸‰ã€Kotlin</h2>
      
    </div>

    

    
    
    

    

    

    

    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;margin:100px 0 20px 0;">------------------------ æœ¬æ–‡ç»“æŸ ------------------------</div>
    
</div>
      
    </div>

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/11/06/android-decompile/" rel="next" title="Androidåç¼–è¯‘çš„ä¸€äº›å§¿åŠ¿">
                <i class="fa fa-chevron-left"></i> Androidåç¼–è¯‘çš„ä¸€äº›å§¿åŠ¿
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/01/01/my-2020/" rel="prev" title="æˆ‘çš„2020">
                æˆ‘çš„2020 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">WhatsID</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/%20%7C%7C%20archive">
                
                    <span class="site-state-item-count">16</span>
                    <span class="site-state-item-name">æ—¥å¿—</span>
                  </a>
                </div>
              

              

              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81Android"><span class="nav-number">1.</span> <span class="nav-text">ä¸€ã€Android</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B-API-28"><span class="nav-number">1.1.</span> <span class="nav-text">Activityå¯åŠ¨æµç¨‹ (API 28)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#View%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B-API-28"><span class="nav-number">1.2.</span> <span class="nav-text">Viewç»˜åˆ¶æµç¨‹ (API 28)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6"><span class="nav-number">1.3.</span> <span class="nav-text">Androidæ¶ˆæ¯æœºåˆ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Binder%E6%9C%BA%E5%88%B6%EF%BC%88%E5%AE%B3%E6%B2%A1%E5%86%99"><span class="nav-number">1.4.</span> <span class="nav-text">Binderæœºåˆ¶ï¼ˆå®³æ²¡å†™</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Android%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B"><span class="nav-number">1.5.</span> <span class="nav-text">Androidç¼–è¯‘æµç¨‹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81Java%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-number">2.</span> <span class="nav-text">äºŒã€JavaåŸºç¡€çŸ¥è¯†</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81Kotlin"><span class="nav-number">3.</span> <span class="nav-text">ä¸‰ã€Kotlin</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WhatsID</span>

  

  
</div>











        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
